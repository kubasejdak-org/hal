.Run_Valgrind:
  stage: valgrind
  variables:
    GIT_STRATEGY: none
  script:
    - cd ${AppArtifact}/bin
    - if [ ! -z "${BeforeRun}" ]; then ${BeforeRun}; sleep 1; fi
    - valgrind --leak-check=full --show-leak-kinds=all --error-exitcode=123 ./${App} ${TestTags} || if [ $? -eq 123 ]; then exit 1; fi

.Run_Valgrind_Linux:
  extends: .Run_Valgrind
  image: kubasejdak/gcc:latest
  tags:
    - linux

.Run_Valgrind_Linux_ARM:
  extends: .Run_Valgrind
  image: kubasejdak/arm-tests:latest
  tags:
    - raspberrypi

#GpioSet1_Linux_ARM_Valgrind:
#  extends: .Run_Valgrind_Linux_ARM
#  tags:
#    - raspberrypi
#    - q39tester
#    - mcp23017
#    - mcp23s17
#  needs:
#    - GpioSet1_Linux_ARM_GCC_Debug_Build
#  variables:
#    AppArtifact: "GpioSet1_Linux_ARM_GCC_Debug_Build"
#    App: "gpio-set1"

Middleware_Linux_Valgrind:
  extends: .Run_Valgrind_Linux
  needs:
    - Middleware_Linux_GCC_Debug_Build
  variables:
    AppArtifact: "Middleware_Linux_GCC_Debug_Build"
    App: "middleware"

PlatformGpio_Linux_ARM_Valgrind:
  extends: .Run_Valgrind_Linux_ARM
  tags:
    - raspberrypi
    - gpio
  needs:
    - PlatformGpio_Linux_ARM_GCC_Debug_Build
  variables:
    AppArtifact: "PlatformGpio_Linux_ARM_GCC_Debug_Build"
    App: "platform-gpio"

PlatformUart_Linux_ARM_Valgrind:
  extends: .Run_Valgrind_Linux_ARM
  tags:
    - raspberrypi
    - uart
  needs:
    - PlatformUart_Linux_ARM_GCC_Debug_Build
  variables:
    AppArtifact: "PlatformUart_Linux_ARM_GCC_Debug_Build"
    App: "platform-uart"
    BeforeRun: "daemon/run.py"
